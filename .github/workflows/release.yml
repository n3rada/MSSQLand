name: Release Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v2.1.0)'
        required: false
        type: string

# Prevent multiple releases from running simultaneously
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

# Minimal permissions following principle of least privilege
permissions:
  contents: write  # Required for creating releases
  actions: read

jobs:
  build:
    name: Build MSSQLand Binaries
    runs-on: windows-latest
    timeout-minutes: 30
    
    strategy:
      matrix:
        include:
          - enable_cm: false
            artifact_name: MSSQLand.exe
            description: Standard Edition
          - enable_cm: true
            artifact_name: MSSQLand-CM.exe
            description: ConfigMgr Edition
    
    steps:
    - name: Checkout code
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
      with:
        fetch-depth: 0  # Full history for version info
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@6fb02220983dee41ce7ae257b6f4d8f9bf5ed4ce  # v2.0.0
    
    - name: Setup NuGet
      uses: NuGet/setup-nuget@a21f25cd3998bf370fde17e3f1b4c12c175172f9  # v2.0.0
    
    - name: Restore NuGet packages
      run: nuget restore MSSQLand/MSSQLand.sln
    
    - name: Build ${{ matrix.description }}
      run: |
        msbuild MSSQLand/MSSQLand.sln `
          /p:Configuration=Release `
          /p:EnableCM=${{ matrix.enable_cm }} `
          /p:Platform=AnyCPU `
          /p:DebugType=none `
          /p:DebugSymbols=false `
          /p:Optimize=true `
          /p:TreatWarningsAsErrors=false `
          /verbosity:minimal `
          /nologo
    
    - name: Rename binary
      run: |
        Copy-Item "MSSQLand/bin/Release/MSSQLand.exe" "${{ matrix.artifact_name }}"
    
    - name: Calculate file hash
      id: hash
      run: |
        $hash = (Get-FileHash "${{ matrix.artifact_name }}" -Algorithm SHA256).Hash
        $size = (Get-Item "${{ matrix.artifact_name }}").Length
        $sizeKB = [math]::Round($size / 1KB, 2)
        echo "sha256=$hash" >> $env:GITHUB_OUTPUT
        echo "size_kb=$sizeKB" >> $env:GITHUB_OUTPUT
    
    - name: Upload artifact
      uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b  # v4.5.0
      with:
        name: ${{ matrix.artifact_name }}
        path: ${{ matrix.artifact_name }}
        if-no-files-found: error
        retention-days: 90
    
    - name: Upload to release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@e7a8f85e1c67a31e6ed99a94b41bd0b71bbee6b8  # v2.2.0
      with:
        files: ${{ matrix.artifact_name }}
        body: |
          ## ${{ matrix.description }}
          
          **Size:** ${{ steps.hash.outputs.size_kb }} KB  
          **SHA256:** `${{ steps.hash.outputs.sha256 }}`
        fail_on_unmatched_files: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
  create-checksums:
    name: Generate Checksums File
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    permissions:
      contents: write
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        path: artifacts
    
    - name: Generate SHA256SUMS file
      run: |
        cd artifacts
        echo "# MSSQLand Release Checksums" > SHA256SUMS.txt
        echo "" >> SHA256SUMS.txt
        echo "Generated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> SHA256SUMS.txt
        echo "Version: ${GITHUB_REF#refs/tags/}" >> SHA256SUMS.txt
        echo "" >> SHA256SUMS.txt
        
        for dir in */; do
          if [ -f "$dir/MSSQLand.exe" ] || [ -f "$dir/MSSQLand-CM.exe" ]; then
            cd "$dir"
            for file in *.exe; do
              if [ -f "$file" ]; then
                sha256sum "$file" >> ../SHA256SUMS.txt
              fi
            done
            cd ..
          fi
        done
        
        cat SHA256SUMS.txt
    
    - name: Upload checksums to release
      uses: softprops/action-gh-release@e7a8f85e1c67a31e6ed99a94b41bd0b71bbee6b8  # v2.2.0
      with:
        files: artifacts/SHA256SUMS.txt
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
